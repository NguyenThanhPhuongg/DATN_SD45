<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container {display: flex;margin-left: auto;margin-right: auto;width: 1200px;background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Thêm đổ bóng */}
        .sidebar { width: 200px; padding: 20px; background-color: #f5f5f5; text-align: center; height: 800px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .user-icon { font-size: 50px; margin-bottom: 10px; }
        .user-name { font-size: 18px; font-weight: bold; }
        .edit-profile { font-size: 12px; color: #007bff; cursor: pointer; }
        .sidebar a { display: block; padding: 10px; text-decoration: none; color: #333; margin-bottom: 5px; }
        .sidebar a:hover { background-color: #ff5722; color: #fff; }
        .content { flex-grow: 1; padding: 20px; margin-left: 20px; background-color: #fff; height: 800px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .form-group input[type="radio"] { width: auto; }
        .form-group .radio-group { display: flex; gap: 10px; }
        .form-group .radio-group label { display: inline; }
        .form-group button { padding: 10px 20px; background-color: #ff5722; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
        .form-group button:hover { background-color: #e64a19; }
        .form-group .dob-group { display: flex; gap: 10px; }
        .form-group .dob-group select { width: auto; flex-grow: 1; }
        .tabs { display: none; }
        .tabs.active { display: block; }
        .tabs ul { list-style-type: none; padding: 0; display: flex; gap: 10px; flex-wrap: nowrap; }
        .tabs ul li { flex-grow: 1; }
        .tabs ul li a { text-decoration: none; padding: 15px; background-color: #f5f5f5; color: #333; display: block; text-align: center; border-radius: 5px; font-size: 16px; }
        .tabs ul li a:hover, .tabs ul li a.active { background-color: #ff5722; color: #fff; }
        .separator { height: 1px; background-color: #ccc; margin: 20px 0; }
        .profile-form-container { display: flex; justify-content: space-between; height: calc(100% - 100px); }
        .profile-form-container .form-section, .profile-form-container .profile-pic-section { flex: 1; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        .profile-form-container .form-section { margin-right: 20px; }
        .profile-pic-section { text-align: center; }
        .profile-pic-section img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .sub-menu a:hover { background-color: #ff5722; color: #fff; }
        .sidebar a.active, .sidebar a:hover {background-color: #ff5722;color: #fff;}
        .notification {position: fixed;bottom: 20px;left: 50%;transform: translateX(-50%);background-color: rgba(0, 0, 0, 0.8);color: #fff;padding: 10px 20px;border-radius: 4px;text-align: center;display: none;width: 200px;}
        .tabs {display: none;}
        .tabs.active {display: block;}
        .profile-form-container .form-section,
        .profile-form-container .profile-pic-section {flex: 1;padding: 20px;background-color: #fff;border-radius: 8px;box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);}
        .address-list {
            margin-top: 20px;
        }

        .address-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .address-item h4 {
            margin: 0 0 5px 0;
        }

        .address-item p {
            margin: 0;
        }

    </style>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div th:include="homeHeader :: body"></div>
<div class="container">
    <div class="sidebar">
        <div class="user-icon"></div>
        <div class="user-name">Tên người dùng</div>
        <div class="edit-profile">Sửa hồ sơ</div>
        <a href="#" id="account-link">Tài khoản của tôi</a>
        <div class="sub-menu" id="account-submenu" style="display:none;">
            <a href="#" id="profile-link">Hồ sơ</a>
            <a href="#" id="change-password-link">Đổi mật khẩu</a>
            <a href="#" id="address-link">Địa chỉ</a>
            <a href="#">Tích điểm</a>
        </div>
        <a href="#" id="orders-link">Đơn mua</a>
    </div>
    <div class="content">
        <div id="profile-form" class="tabs active">
            <h2>Hồ sơ của tôi</h2>
            <p>Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
            <div class="separator"></div>
            <div class="profile-form-container">
                <div class="form-section">
                    <div class="form-group">
                        <label for="username">Tên đăng nhập</label>
                        <input type="text" id="username" name="username" readonly>
                    </div>
                    <div class="form-group">
                        <label for="name">Tên</label>
                        <input type="text" id="name" name="name">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email">
                        <a style="color: #0a53be" href="#">Thay Đổi</a>
                    </div>
                    <div class="form-group">
                        <label for="phone">Số điện thoại</label>
                        <input type="text" id="phone" name="phone">
                        <a style="color: #0a53be" href="#">Thay Đổi</a>
                    </div>
                    <div class="form-group">
                        <label for="cccd">CCCD</label>
                        <input type="text" id="cccd" name="cccd">
                    </div>
                    <div class="form-group">
                        <label>Giới tính</label>
                        <div class="radio-group">
                            <label><input type="radio" name="gender" value="NAM"> Nam</label>
                            <label><input type="radio" name="gender" value="NU"> Nữ</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dob">Ngày sinh</label>
                        <input type="date" id="dob" name="dob">
                    </div>
                </div>
                <div class="profile-pic-section">
                    <img src="profile-placeholder.png" alt="Profile Picture">
                    <div class="form-group">
                        <label for="profile-pic">Ảnh đại diện</label>
                        <input type="file" id="profile-pic" name="profile-pic">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <button type="submit" id="update-button">Cập Nhật</button>
            </div>
        </div>
        <div id="password-form" class="tabs">
            <h2>Đổi Mật Khẩu</h2>
            <p>Đổi mật khẩu tài khoản của bạn</p>
            <div class="separator"></div>
            <form class="profile-form-container">
                <div class="form-section">
                    <div class="form-group">
                        <label for="old-password">Mật khẩu cũ</label>
                        <input type="password" id="old-password" name="old-password">
                    </div>
                    <div class="form-group">
                        <label for="new-password">Mật khẩu mới</label>
                        <input type="password" id="new-password" name="new-password">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Xác nhận mật khẩu</label>
                        <input type="password" id="confirm-password" name="confirm-password">
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" id="change-password-button">Đổi Mật Khẩu</button>
                </div>
            </form>
        </div>
        <div id="address-form" class="tabs">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Địa chỉ của tôi</h2>
                <button type="button" id="add-address-button" style="background-color: #ff5722; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Thêm địa chỉ mới</button>
            </div>
            <div class="separator"></div>
            <div id="address-list" class="address-list">
                <!-- Danh sách địa chỉ sẽ được hiển thị tại đây -->
            </div>
        </div>

        <div id="orders-tabs" class="tabs">
            <ul>
                <li><a href="#" class="tab-link" data-tab="tat-ca">Tất cả</a></li>
                <li><a href="#" class="tab-link" data-tab="cho-thanh-toan">Chờ thanh toán</a></li>
                <li><a href="#" class="tab-link" data-tab="van-chuyen">Vận chuyển</a></li>
                <li><a href="#" class="tab-link" data-tab="cho-giao-hang">Chờ giao hàng</a></li>
                <li><a href="#" class="tab-link" data-tab="hoan-thanh">Hoàn Thành</a></li>
                <li><a href="#" class="tab-link" data-tab="da-huy">Đã hủy</a></li>
                <li><a href="#" class="tab-link" data-tab="tra-hang-hoan-tien">Trả hàng/Hoàn tiền</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="notification" class="notification"></div>

<div th:include="footer::body"></div>
<script>
    document.getElementById('account-link').addEventListener('click', function() {
        var submenu = document.getElementById('account-submenu');
        if (submenu.style.display === 'none' || submenu.style.display === '') {
            submenu.style.display = 'block';
        } else {
            submenu.style.display = 'none';
        }
    });

    document.getElementById('profile-link').addEventListener('click', function() {
        document.getElementById('profile-form').classList.add('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('address-form').classList.remove('active');
    });


    document.getElementById('orders-link').addEventListener('click', function() {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.add('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('address-form').classList.remove('active');
    });

    // Add click event listener for tab links
    document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', function() {
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
        });
    });
    document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', function() {
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Hàm để gọi API lấy dữ liệu người dùng
    async function layDuLieuNguoiDung(token) {
        const response = await fetch('user/get', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            return data;
        } else {
            console.error('Lỗi khi lấy dữ liệu người dùng');
        }
    }

    // Hàm để gán thông tin vào form hồ sơ cá nhân
    async function ganThongTinVaoForm() {
        const token = localStorage.getItem('token');
        if (token) {
            const duLieuNguoiDung = await layDuLieuNguoiDung(token);
            if (duLieuNguoiDung) {
                const profile = duLieuNguoiDung.data.profile;
                document.getElementById('username').value = duLieuNguoiDung.data.userName || '';
                document.getElementById('name').value = profile.hoVaTen || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('cccd').value = profile.cccd || '';
                document.getElementById('dob').value = profile.ngaySinh || '';

                // Xử lý giới tính
                if (profile.gioiTinh === 'NAM') {
                    document.querySelector('input[name="gender"][value="NAM"]').checked = true;
                } else if (profile.gioiTinh === 'NU') {
                    document.querySelector('input[name="gender"][value="NU"]').checked = true;
                }
            }
        }
    }

    // Gọi hàm ganThongTinVaoForm khi trang được tải
    window.onload = ganThongTinVaoForm;


    // Hàm hiển thị thông báo
    function hienThiThongBao(message, success = true) {
        const notification = document.getElementById('notification');
        notification.innerText = message;
        notification.style.backgroundColor = success ? 'rgba(0, 128, 0, 0.8)' : 'rgba(255, 0, 0, 0.8)';
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Hàm để lấy giá trị từ form và tạo yêu cầu cập nhật
    function updateRequest() {
        return {
            hoVaTen: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            cccd: document.getElementById('cccd').value,
            gioiTinh: document.querySelector('input[name="gender"]:checked').value,
            ngaySinh: document.getElementById('dob').value
        };
    }
    // Hàm để gọi API cập nhật thông tin người dùng
    async function updateProfile(request) {
        const token = localStorage.getItem('token');
        const response = await fetch('profile/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(request)
        });
        if (response.ok) {
            const data = await response.json();
            console.log('Cập nhật thành công:', data);
            hienThiThongBao('Cập nhật thành công!', true);
        } else {
            console.error('Lỗi khi cập nhật thông tin');
            hienThiThongBao('Có lỗi xảy ra khi cập nhật thông tin.', false);
        }
    }

    // Gán sự kiện click cho nút Cập Nhật
    document.getElementById('update-button').addEventListener('click', function(event) {
        event.preventDefault();
        const request = updateRequest();
        updateProfile(request);
    });

    // Gán sự kiện click cho liên kết "Đổi mật khẩu"
    document.getElementById('change-password-link').addEventListener('click', function() {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('password-form').classList.add('active');
        document.getElementById('address-form').classList.remove('active');
    });
    // Hàm để gọi API đổi mật khẩu
    async function doiMatKhau(request) {
        const token = localStorage.getItem('token');
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(request)
        });
        if (response.ok) {
            hienThiThongBao('Đổi mật khẩu thành công!', true);
            // Clear the password form
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            // Chuyển trở lại form hồ sơ và áp dụng hiệu ứng hover
            document.getElementById('password-form').classList.remove('active');
            document.getElementById('profile-form').classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            document.getElementById('profile-link').classList.add('active');
        }  else {
            hienThiThongBao('Có lỗi xảy ra khi đổi mật khẩu.', false);
        }
    }

    // Gán sự kiện click cho nút "Đổi mật khẩu"
    document.getElementById('change-password-button').addEventListener('click', function(event) {
        event.preventDefault();
        const oldPassword = document.getElementById('old-password').value;
        const password = document.getElementById('new-password').value;
        const retypePassword = document.getElementById('confirm-password').value;

        // Kiểm tra mật khẩu mới và xác nhận mật khẩu có khớp nhau không
        if (password !== retypePassword) {
            hienThiThongBao('Mật khẩu mới và xác nhận mật khẩu không khớp.', false);
            return;
        }

        // Tạo đối tượng yêu cầu đổi mật khẩu và gọi hàm doiMatKhau
        const request = { oldPassword, password, retypePassword };
        doiMatKhau(request);
    });

    // Hàm để gọi API lấy danh sách địa chỉ
    async function layDanhSachDiaChi() {
        const token = localStorage.getItem('token');
        const response = await fetch('/dia-chi/get', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            return data.listData; // Điều chỉnh theo cấu trúc phản hồi API của bạn
        } else {
            console.error('Lỗi khi lấy danh sách địa chỉ');
        }
    }

    // Hàm để hiển thị danh sách địa chỉ
    async function hienThiDanhSachDiaChi() {
        const diaChiList = await layDanhSachDiaChi();
        const addressListContainer = document.getElementById('address-list');
        addressListContainer.innerHTML = ''; // Xóa nội dung cũ

        if (diaChiList) {
            diaChiList.forEach(diaChi => {
                const addressItem = document.createElement('div');
                addressItem.classList.add('address-item');
                addressItem.innerHTML = `
                <h4>${diaChi.hoVaTen} (+${diaChi.maQuocGia}) ${diaChi.soDienThoai}</h4>
                <p>${diaChi.diaChi}</p>
                <p>${diaChi.phuongXa}, ${diaChi.quanHuyen}, ${diaChi.tinhThanhPho}</p>
            `;
                addressListContainer.appendChild(addressItem);
            });
        } else {
            addressListContainer.innerHTML = '<p>Không có địa chỉ nào.</p>';
        }
    }

    // Gọi hàm hiển thị danh sách địa chỉ khi form "Địa chỉ" được kích hoạt
    document.getElementById('address-link').addEventListener('click', function() {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('address-form').classList.add('active');
        hienThiDanhSachDiaChi();
    });

    // Gán sự kiện click cho nút "Thêm địa chỉ mới"
    document.getElementById('add-address-button').addEventListener('click', function() {
        // Code to handle adding a new address can go here
        hienThiThongBao('Chức năng Thêm địa chỉ mới sẽ được triển khai.');
    });

</script>
</body>
</html>
